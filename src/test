"use client";

import React, { useContext, useEffect, useRef } from "react";
import { createRoot, type Root } from "react-dom/client";
import { GoogleMapContext } from "./googleMapContext";

type ControlPositionName =
  | "TOP_LEFT" | "TOP_CENTER" | "TOP_RIGHT"
  | "LEFT_TOP" | "RIGHT_TOP" | "LEFT_CENTER" | "RIGHT_CENTER"
  | "LEFT_BOTTOM" | "RIGHT_BOTTOM"
  | "BOTTOM_LEFT" | "BOTTOM_CENTER" | "BOTTOM_RIGHT";

export type MapControlProps = {
  position: ControlPositionName | google.maps.ControlPosition;
  index?: number;
  disabled?: boolean;
  className?: string;
  children: React.ReactNode;
};

export function MapControl({
  position,
  index,
  disabled,
  className,
  children,
}: MapControlProps) {
  const map = useContext(GoogleMapContext);

  const containerRef = useRef<HTMLDivElement | null>(null);
  const rootRef = useRef<Root | null>(null);
  const insertedPosRef = useRef<google.maps.ControlPosition | null>(null);

  // 1) Create container once
  useEffect(() => {
    const el = document.createElement("div");
    containerRef.current = el;

    return () => {
      // Unmount React root if it exists
      rootRef.current?.unmount();
      rootRef.current = null;

      containerRef.current = null;
    };
  }, []);

  // 2) Keep className in sync
  useEffect(() => {
    if (!containerRef.current) return;
    containerRef.current.className = className ?? "";
  }, [className]);

  // 3) Insert/remove container in Google controls (same logic as before)
  useEffect(() => {
    const el = containerRef.current;
    if (!map) return;
    if (disabled) return;
    if (!el) return;
    if (!window.google?.maps?.ControlPosition) return;

    const normalizedPos =
      typeof position === "string"
        ? window.google.maps.ControlPosition[position]
        : position;

    if (normalizedPos === undefined) {
      console.error("Invalid control position:", position);
      return;
    }

    // If already inserted somewhere else, remove first
    if (
      insertedPosRef.current !== null &&
      insertedPosRef.current !== normalizedPos
    ) {
      const oldPos = insertedPosRef.current;
      const oldArr = map.controls[oldPos];
      const oldIdx = oldArr.getArray().indexOf(el);
      if (oldIdx >= 0) oldArr.removeAt(oldIdx);
      insertedPosRef.current = null;
    }

    // Insert if not already inserted
    if (insertedPosRef.current === null) {
      const arr = map.controls[normalizedPos];

      if (typeof index === "number") {
        const safeIndex = Math.max(0, Math.min(index, arr.getLength()));
        arr.insertAt(safeIndex, el);
      } else {
        arr.push(el);
      }

      insertedPosRef.current = normalizedPos;
    } else {
      // Already inserted at same position. If index changes, reposition it.
      if (typeof index === "number") {
        const arr = map.controls[normalizedPos];
        const currentIdx = arr.getArray().indexOf(el);
        const desiredIdx = Math.max(0, Math.min(index, arr.getLength() - 1));

        if (currentIdx !== -1 && currentIdx !== desiredIdx) {
          arr.removeAt(currentIdx);
          arr.insertAt(desiredIdx, el);
        }
      }
    }

    return () => {
      const pos = insertedPosRef.current;
      if (pos === null) return;

      const arr = map.controls[pos];
      const i = arr.getArray().indexOf(el);
      if (i >= 0) arr.removeAt(i);

      insertedPosRef.current = null;
    };
  }, [map, disabled, position, index]);

  // 4) Render children into the container (no portal)
  useEffect(() => {
    const el = containerRef.current;
    if (!el) return;

    // If disabled, unmount any rendered UI
    if (disabled) {
      rootRef.current?.unmount();
      rootRef.current = null;
      return;
    }

    // Create root once and render
    if (!rootRef.current) {
      rootRef.current = createRoot(el);
    }

    rootRef.current.render(<>{children}</>);
  }, [children, disabled]);

  // React should not own the DOM placement, so render nothing
  return null;
}
